{
  "StartAt": "Initialize",
  "States": {
    "Initialize": {
      "Type": "Pass",
      "ResultPath": "$",
      "Parameters": {
        "vars.$": "$$.Execution.Input"
      },
      "Next": "13: createBillJob(input)"
    },
    "13: createBillJob(input)": {
      "Type": "Task",
      "ResultPath": "$.vars.billJob",
      "Resource": "typescript:createBillJob",
      "InputPath": "$.vars",
      "Comment": "source: createBillJob(input)",
      "Next": "Wait"
    },
    "Wait": {
      "Type": "Wait",
      "Seconds": 120,
      "Next": "16: createNonEmptyBills(billJob)"
    },
    "16: createNonEmptyBills(billJob)": {
      "Type": "Task",
      "ResultPath": "$.vars.jobResult",
      "Resource": "typescript:createNonEmptyBills",
      "InputPath": "$.vars.billJob",
      "Comment": "source: createNonEmptyBills(billJob)",
      "Next": "16: Assign billPromises"
    },
    "16: Assign billPromises": {
      "Type": "Map",
      "ResultPath": "$.vars.billPromises",
      "Iterator": {
        "StartAt": "18: Assign approveNonEmptyBil ...",
        "States": {
          "18: Assign approveNonEmptyBil ...": {
            "Type": "Pass",
            "ResultPath": "$.vars.approveNonEmptyBillRequest",
            "Parameters": {
              "lastDateInBillingPeriod.$": "$.vars.jobResult.lastDateInBillingPeriod",
              "bill.$": "$.vars.bill"
            },
            "Comment": "source: approveNonEmptyBillRequest = { lastDateInBilli ...",
            "Next": "20: approveNonEmptyBill(appro ..."
          },
          "20: approveNonEmptyBill(appro ...": {
            "Type": "Task",
            "ResultPath": "$.vars.approvalResult",
            "Resource": "typescript:approveNonEmptyBill",
            "InputPath": "$.vars.approveNonEmptyBillRequest",
            "Comment": "source: approveNonEmptyBill(approveNonEmptyBillRequest)",
            "Next": "20: If (approvalResult.valid)"
          },
          "20: If (approvalResult.valid)": {
            "Type": "Choice",
            "Choices": [
              {
                "Variable": "$.vars.approvalResult.valid",
                "IsPresent": true,
                "Next": "Pass"
              }
            ],
            "Default": "Pass"
          },
          "Pass": {
            "Type": "Pass",
            "Parameters": {
              "valid.$": "$.vars.approvalResult.valid",
              "billable.$": "$.vars.approvalResult.billable",
              "billId.$": "$.vars.approvalResult.billId",
              "accountId.$": "$.vars.approvalResult.accountId",
              "accountCode.$": "$.vars.approvalResult.accountCode",
              "accountType.$": "$.vars.approvalResult.accountType"
            },
            "End": true
          }
        }
      },
      "ItemsPath": "$.vars.jobResult.bills",
      "Parameters": {
        "vars": {
          "bill.$": "$$.Map.Item.Value",
          "jobResult.$": "$.vars.jobResult"
        }
      },
      "Next": "45: Assign bills"
    },
    "45: Assign bills": {
      "Type": "Pass",
      "ResultPath": "$.vars.bills",
      "InputPath": "$.vars.billPromises",
      "Next": "47: Assign validBills"
    },
    "47: Assign validBills": {
      "Type": "Pass",
      "ResultPath": "$.vars.validBills",
      "InputPath": "$.vars.bills[?(!(@.valid))]",
      "Next": "48: Assign invoices"
    },
    "48: Assign invoices": {
      "Type": "Map",
      "ResultPath": "$.vars.invoices",
      "Iterator": {
        "StartAt": "50: createInvoice(x)",
        "States": {
          "50: createInvoice(x)": {
            "Type": "Task",
            "Resource": "typescript:createInvoice",
            "InputPath": "$.vars.x",
            "Comment": "source: createInvoice(x)",
            "End": true
          }
        }
      },
      "ItemsPath": "$.vars.validBills",
      "Comment": "source: validBills.map(async x => createInvoice(x))",
      "Parameters": {
        "vars": {
          "x.$": "$.vars.x"
        }
      },
      "Next": "50: Assign validatedInvoices"
    },
    "50: Assign validatedInvoices": {
      "Type": "Map",
      "ResultPath": "$.vars.validatedInvoices",
      "Iterator": {
        "StartAt": "51: validateInvoice(x)",
        "States": {
          "51: validateInvoice(x)": {
            "Type": "Task",
            "Resource": "typescript:validateInvoice",
            "InputPath": "$.vars.x",
            "Comment": "source: validateInvoice(x)",
            "End": true
          }
        }
      },
      "ItemsPath": "$.vars.invoices",
      "Comment": "source: invoices.map(async x => validateInvoice(x))",
      "Parameters": {
        "vars": {
          "x.$": "$.vars.x"
        }
      },
      "Next": "51: Assign invalidInvoices"
    },
    "51: Assign invalidInvoices": {
      "Type": "Pass",
      "ResultPath": "$.vars.invalidInvoices",
      "InputPath": "$.vars.validatedInvoices[?(!(@.valid))]",
      "Next": "53: If (invalidInvoices.lengt ..."
    },
    "53: If (invalidInvoices.lengt ...": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.vars.invalidInvoices.length()",
          "StringGreaterThan": 0,
          "Next": "55: createGithubIssue({ bills ..."
        }
      ],
      "Default": "56: Assign validInvoices"
    },
    "55: createGithubIssue({ bills ...": {
      "Type": "Task",
      "Resource": "typescript:createGithubIssue",
      "Parameters": {
        "bills": {
          "invalid.$": "$.vars.invalidInvoices"
        }
      },
      "Next": "56: Assign validInvoices"
    },
    "56: Assign validInvoices": {
      "Type": "Pass",
      "ResultPath": "$.vars.validInvoices",
      "InputPath": "$.vars.validatedInvoices[?(@.valid == true)]",
      "Next": "58: If (!input.shouldFinalize)"
    },
    "58: If (!input.shouldFinalize)": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.vars.shouldFinalize",
          "IsPresent": false,
          "Next": "Empty"
        }
      ],
      "Comment": "source: if (!input.shouldFinalize) { return; }",
      "Default": "62: For invoice Of validInvoices"
    },
    "Empty": {
      "Type": "Succeed"
    },
    "62: For invoice Of validInvoices": {
      "Type": "Map",
      "ResultPath": "$.lastResult",
      "Iterator": {
        "StartAt": "64: If (invoice.billable)",
        "States": {
          "64: If (invoice.billable)": {
            "Type": "Choice",
            "Choices": [
              {
                "Variable": "$.vars.invoice.billable",
                "IsPresent": true,
                "Next": "66: finallizeInvoice(invoice ..."
              }
            ],
            "Default": "66: finallizeInvoice(invoice ..."
          },
          "66: finallizeInvoice(invoice ...": {
            "Type": "Task",
            "Resource": "typescript:finallizeInvoice",
            "InputPath": "$.vars.invoice",
            "End": true
          }
        }
      },
      "ItemsPath": "$.vars.validInvoices",
      "Parameters": {
        "vars": {
          "invoice.$": "$$.Map.Item.Value"
        }
      },
      "End": true
    }
  }
}