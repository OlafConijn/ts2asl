{
  "StartAt": "Initialize",
  "States": {
    "Initialize": {
      "Type": "Pass",
      "ResultPath": "$",
      "Parameters": {
        "vars.$": "$$.Execution.Input"
      },
      "Next": "ListObjectsV2"
    },
    "ListObjectsV2": {
      "Type": "Task",
      "ResultPath": "$.vars.objects",
      "Resource": "arn:aws:states:::aws-sdk:s3:listObjectsV2",
      "Parameters": {
        "Prefix.$": "$.vars.prefix",
        "Bucket": "preprod-metrics-bucket-us-east-1"
      },
      "Next": "Assign itemsWithKeys"
    },
    "Assign itemsWithKeys": {
      "Type": "Pass",
      "ResultPath": "$.vars.itemsWithKeys",
      "InputPath": "$.vars.objects.Contents[?(@.Key)]",
      "Next": "Assign keys"
    },
    "Assign keys": {
      "Type": "Map",
      "ResultPath": "$.vars.keys",
      "Iterator": {
        "StartAt": "Assign ???",
        "States": {
          "Assign ???": {
            "Type": "Pass",
            "ResultPath": "$.vars.return_var",
            "InputPath": "$.vars.x.Key",
            "Next": "Pass"
          },
          "Pass": {
            "End": true,
            "Type": "Pass",
            "InputPath": "$.vars.return_var"
          }
        }
      },
      "ItemsPath": "$.vars.itemsWithKeys",
      "Comment": "source: itemsWithKeys.map(x => x.Key)",
      "Parameters": {
        "vars": {
          "x.$": "$$.Map.Item.Value"
        }
      },
      "Next": "Map"
    },
    "Map": {
      "Type": "Map",
      "ResultPath": "$.tmp.lastResult",
      "Iterator": {
        "StartAt": "Assign message",
        "States": {
          "Assign message": {
            "Type": "Pass",
            "ResultPath": "$.vars.message",
            "Parameters": {
              "Records": [
                {
                  "replay": true,
                  "eventSource": "aws:s3",
                  "awsRegion": "us-east-1",
                  "eventName": "ObjectCreated:Put",
                  "s3": {
                    "s3SchemaVersion": "1.0",
                    "bucket": {
                      "name": "preprod-metrics-bucket-us-east-1",
                      "arn": "arn:aws:s3:::preprod-metrics-bucket-us-east-1"
                    },
                    "object": {
                      "key.$": "$.vars.key"
                    }
                  }
                }
              ]
            },
            "Comment": "source: message = { Records: [ { replay: true, eventSo ...",
            "Next": "Publish"
          },
          "Publish": {
            "Type": "Task",
            "Resource": "arn:aws:states:::aws-sdk:sns:publish",
            "Parameters": {
              "TopicArn": "arn:aws:sns:us-east-1:400780617693:CentralizedMetricsStream-preprod-CentralizedMetricsStreamTopic48052E47-1X7SNV6Y357H6",
              "Subject": "Ingestion Replay S3",
              "Message.$": "States.JsonToString($.vars.message)"
            },
            "End": true
          }
        }
      },
      "ItemsPath": "$.vars.keys",
      "MaxConcurrency": 5,
      "Parameters": {
        "vars": {
          "key.$": "$$.Map.Item.Value"
        }
      },
      "End": true
    }
  }
}